<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korvo1 Firmware Flasher</title>
    <script src="https://cdn.jsdelivr.net/npm/esptool-js@12.2.0/dist/esptool.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        select, input[type="file"], button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            display: none;
        }

        .log-line {
            margin-bottom: 5px;
        }

        .log-success {
            color: #4caf50;
        }

        .log-error {
            color: #f44336;
        }

        .log-info {
            color: #2196f3;
        }

        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .warning strong {
            color: #856404;
        }

        .info-box {
            background: #e3f2fd;
            border-left-color: #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-box strong {
            color: #1565c0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Korvo1 Firmware Flasher</h1>
        <p class="subtitle">Flash firmware releases to your ESP32-S3 Korvo1 board using your browser</p>

        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> Make sure your Korvo1 board is connected via USB and put it into download mode (hold BOOT button and press RESET, then release BOOT).
        </div>

        <div class="section">
            <h2>1. Select Release Version</h2>
            <label for="releaseSelect">Choose a firmware release:</label>
            <select id="releaseSelect">
                <option value="">Loading releases...</option>
            </select>
            <div id="releaseInfo" class="info-box" style="display: none;">
                <strong>Release Info:</strong> <span id="releaseDetails"></span>
            </div>
        </div>

        <div class="section">
            <h2>2. Select Firmware File</h2>
            <label for="firmwareFile">Or upload a firmware file directly (if not using a release):</label>
            <input type="file" id="firmwareFile" accept=".bin">
            <div id="fileInfo" class="file-info" style="display: none;"></div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                <strong>Note:</strong> For complete flashing, you may need bootloader.bin and partition-table.bin files. 
                The release selection above includes all necessary files.
            </p>
        </div>

        <div class="section">
            <h2>3. Select Serial Port</h2>
            <label for="portSelect">Serial Port:</label>
            <select id="portSelect">
                <option value="">Click "Connect" to list available ports</option>
            </select>
            <button id="connectBtn" onclick="connectSerial()">Connect to Serial Port</button>
        </div>

        <div class="section">
            <h2>4. Flash Firmware</h2>
            <button id="flashBtn" onclick="flashFirmware()" disabled>Flash Firmware</button>
            
            <div id="progress" class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div id="statusText" style="text-align: center; color: #666; font-weight: 600;"></div>
            </div>

            <div id="log" class="log"></div>
        </div>

        <div class="info-box">
            <strong>üí° Tips:</strong>
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>If you don't see your serial port, make sure the device is connected and drivers are installed</li>
                <li>For ESP32-S3, you may need to hold BOOT and press RESET to enter download mode</li>
                <li>Firmware files are typically named <code>naphome-korvo1.bin</code> or <code>firmware.bin</code></li>
                <li>This tool uses esptool.js - a JavaScript port of esptool</li>
            </ul>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'Naptick';
        const REPO_NAME = 'Naphome-Korvo1';
        let selectedPort = null;
        let firmwareData = null;

        // Load releases from GitHub API
        async function loadReleases() {
            const select = document.getElementById('releaseSelect');
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases`);
                const releases = await response.json();
                
                if (releases.length === 0) {
                    select.innerHTML = '<option value="">No releases found</option>';
                    return;
                }

                select.innerHTML = '<option value="">Select a release...</option>';
                releases.forEach(release => {
                    const option = document.createElement('option');
                    option.value = release.tag_name;
                    option.textContent = `${release.tag_name} - ${release.name || release.tag_name}`;
                    option.dataset.url = release.html_url;
                    option.dataset.assets = JSON.stringify(release.assets);
                    select.appendChild(option);
                });
            } catch (error) {
                log('Error loading releases: ' + error.message, 'error');
                select.innerHTML = '<option value="">Error loading releases</option>';
            }
        }

        // Handle release selection
        document.getElementById('releaseSelect').addEventListener('change', async function() {
            const selected = this.options[this.selectedIndex];
            if (!selected.value) {
                document.getElementById('releaseInfo').style.display = 'none';
                firmwareData = null;
                checkReady();
                return;
            }

            const assets = JSON.parse(selected.dataset.assets || '[]');
            const binAssets = assets.filter(a => a.name.endsWith('.bin'));
            
            if (binAssets.length === 0) {
                log('No .bin files found in this release', 'error');
                document.getElementById('releaseInfo').style.display = 'none';
                return;
            }

            // Show release info
            document.getElementById('releaseInfo').style.display = 'block';
            document.getElementById('releaseDetails').textContent = 
                `${selected.textContent} - ${binAssets.length} firmware file(s) available`;

            // Find the main application binary (naphome-korvo1.bin)
            const mainApp = binAssets.find(a => a.name.includes('naphome-korvo1') || a.name.includes('firmware'));
            const bootloader = binAssets.find(a => a.name.includes('bootloader'));
            const partition = binAssets.find(a => a.name.includes('partition'));

            // Log available files
            log(`Release ${selected.value} selected. Found firmware files:`, 'info');
            binAssets.forEach(asset => {
                log(`  - ${asset.name} (${(asset.size / 1024).toFixed(1)} KB)`, 'info');
            });

            // If we have the main app binary, download it
            if (mainApp) {
                await downloadFirmware(mainApp.browser_download_url, mainApp.name);
            } else if (binAssets.length === 1) {
                // Only one file, use it
                await downloadFirmware(binAssets[0].browser_download_url, binAssets[0].name);
            } else {
                log('Multiple firmware files found. Please select the main application binary (naphome-korvo1.bin)', 'info');
                log('Or use the file upload option below to select a specific firmware file.', 'info');
            }
        });

        // Handle file selection
        document.getElementById('firmwareFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                // If file cleared, check if we have release data
                if (!firmwareData) {
                    document.getElementById('fileInfo').style.display = 'none';
                    checkReady();
                }
                return;
            }

            // Clear release selection when file is selected
            document.getElementById('releaseSelect').value = '';
            document.getElementById('releaseInfo').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(event) {
                firmwareData = new Uint8Array(event.target.result);
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').textContent = 
                    `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                log(`Firmware file loaded: ${file.name}`, 'success');
                checkReady();
            };
            reader.readAsArrayBuffer(file);
        });

        // Download firmware from release
        async function downloadFirmware(url, filename) {
            log(`Downloading firmware: ${filename}...`, 'info');
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                firmwareData = new Uint8Array(arrayBuffer);
                log(`Firmware downloaded: ${filename} (${(firmwareData.length / 1024).toFixed(1)} KB)`, 'success');
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('fileInfo').textContent = 
                    `Loaded: ${filename} (${(firmwareData.length / 1024).toFixed(1)} KB)`;
                checkReady();
            } catch (error) {
                log('Error downloading firmware: ' + error.message, 'error');
            }
        }

        // Connect to serial port
        async function connectSerial() {
            const connectBtn = document.getElementById('connectBtn');
            const portSelect = document.getElementById('portSelect');
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading"></span>Connecting...';
                
                if (!navigator.serial) {
                    throw new Error('Web Serial API not supported. Please use Chrome, Edge, or Opera browser.');
                }

                const port = await navigator.serial.requestPort();
                selectedPort = port;
                
                await port.open({ baudRate: 115200 });
                
                portSelect.innerHTML = `<option value="connected">Connected: ${port.getInfo().usbProductId || 'Serial Port'}</option>`;
                log('Serial port connected successfully', 'success');
                checkReady();
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    log('No port selected', 'info');
                } else {
                    log('Error connecting to serial port: ' + error.message, 'error');
                }
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect to Serial Port';
            }
        }

        // Check if ready to flash
        function checkReady() {
            const flashBtn = document.getElementById('flashBtn');
            if (firmwareData && selectedPort) {
                flashBtn.disabled = false;
            } else {
                flashBtn.disabled = true;
            }
        }

        // Flash firmware
        async function flashFirmware() {
            if (!firmwareData || !selectedPort) {
                log('Please select firmware and connect to serial port first', 'error');
                return;
            }

            const flashBtn = document.getElementById('flashBtn');
            const progress = document.getElementById('progress');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            const logDiv = document.getElementById('log');

            flashBtn.disabled = true;
            progress.style.display = 'block';
            logDiv.style.display = 'block';
            logDiv.innerHTML = '';

            try {
                log('Initializing esptool...', 'info');
                
                // Create esptool instance
                const esptool = new ESPToolJS({
                    port: selectedPort,
                    baud: 115200,
                    logFunction: (message) => {
                        log(message, 'info');
                    }
                });

                log('Connecting to ESP32-S3...', 'info');
                await esptool.connect();
                log('Connected! Reading chip info...', 'success');

                const chipInfo = await esptool.chip_info();
                log(`Chip: ${chipInfo.chip_name}, Features: ${chipInfo.features}`, 'info');
                log(`Chip ID: 0x${chipInfo.chip_id.toString(16)}`, 'info');

                // Erase flash
                log('Erasing flash (this may take a while)...', 'info');
                statusText.textContent = 'Erasing flash...';
                await esptool.erase_flash();
                log('Flash erased', 'success');

                // Write firmware
                log('Writing firmware...', 'info');
                statusText.textContent = 'Writing firmware...';
                
                const address = 0x10000; // Default app partition address for ESP32-S3
                const chunkSize = 0x1000; // 4KB chunks
                const totalChunks = Math.ceil(firmwareData.length / chunkSize);

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, firmwareData.length);
                    const chunk = firmwareData.slice(start, end);
                    
                    await esptool.write_flash(address + start, chunk);
                    
                    const progress = Math.round(((i + 1) / totalChunks) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }

                log('Firmware written successfully', 'success');

                // Verify
                log('Verifying firmware...', 'info');
                statusText.textContent = 'Verifying firmware...';
                const verifyData = await esptool.read_flash(address, firmwareData.length);
                
                let verified = true;
                for (let i = 0; i < firmwareData.length; i++) {
                    if (firmwareData[i] !== verifyData[i]) {
                        verified = false;
                        break;
                    }
                }

                if (verified) {
                    log('Verification successful!', 'success');
                } else {
                    log('Verification failed - data mismatch', 'error');
                }

                // Reset device
                log('Resetting device...', 'info');
                statusText.textContent = 'Resetting device...';
                await esptool.reset();
                log('Device reset. Flashing complete!', 'success');
                
                statusText.textContent = '‚úÖ Flashing complete!';
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';

            } catch (error) {
                log('Error during flashing: ' + error.message, 'error');
                statusText.textContent = '‚ùå Flashing failed';
                console.error(error);
            } finally {
                flashBtn.disabled = false;
                if (selectedPort) {
                    try {
                        await selectedPort.close();
                    } catch (e) {
                        // Ignore close errors
                    }
                }
            }
        }

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = 'log-line log-' + type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadReleases();
            
            // Check for Web Serial API support
            if (!navigator.serial) {
                document.getElementById('connectBtn').disabled = true;
                log('Web Serial API not supported. Please use Chrome, Edge, or Opera browser.', 'error');
            }
        });
    </script>
</body>
</html>
