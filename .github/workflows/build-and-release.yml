name: Build and Release Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for version calculation

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.4
        target: esp32s3

    - name: Build firmware
      run: |
        idf.py build

    - name: Get next version number
      id: get_version
      run: |
        # Get the latest release version
        LATEST_RELEASE=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")
        
        if [ -z "$LATEST_RELEASE" ]; then
          # No releases yet, start at v1.0.0
          NEW_VERSION="v1.0.0"
        else
          # Extract version number (e.g., v1.2.3 -> 1.2.3)
          VERSION_NUM=$(echo "$LATEST_RELEASE" | sed 's/v//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Previous version: $LATEST_RELEASE"
        echo "New version: $NEW_VERSION"

    - name: Create release archive
      run: |
        mkdir -p release
        cp build/bootloader/bootloader.bin release/
        cp build/partition_table/partition-table.bin release/
        cp build/naphome-korvo1.bin release/
        
        # Create a merged firmware.bin if possible (optional)
        # This would require esptool merge_bin, but we'll include all files separately
        
        # Create a flash script for convenience
        cat > release/flash.sh << 'EOF'
#!/bin/bash
# Flash script for Korvo1 firmware
# Usage: ./flash.sh /dev/ttyUSB0

PORT=${1:-/dev/ttyUSB0}

esptool.py --chip esp32s3 --port $PORT --baud 921600 \
  --before default_reset --after hard_reset write_flash \
  -z --flash_mode dio --flash_freq 80m --flash_size detect \
  0x0 bootloader.bin \
  0x8000 partition-table.bin \
  0x10000 naphome-korvo1.bin

echo "Firmware flashed successfully!"
EOF
        chmod +x release/flash.sh
        
        # Create flash_args file for esptool
        cat > release/flash_args.txt << EOF
0x0 bootloader.bin
0x8000 partition-table.bin
0x10000 naphome-korvo1.bin
EOF

    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        COMMIT_MSG=$(git log -1 --pretty=%B)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        gh release create "$VERSION" \
          --title "Release $VERSION" \
          --notes "Automated release from commit $COMMIT_SHA

        $COMMIT_MSG

        ## Firmware Files
        - \`bootloader.bin\` - Bootloader binary
        - \`partition-table.bin\` - Partition table
        - \`naphome-korvo1.bin\` - Main application firmware
        - \`flash.sh\` - Flash script for Linux/macOS
        - \`flash_args.txt\` - Flash arguments for esptool

        ## Flashing Instructions
        Use the [GitHub Pages flasher](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/) to flash this firmware, or use esptool directly:

        \`\`\`bash
        esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 \\
          --before default_reset --after hard_reset write_flash \\
          -z --flash_mode dio --flash_freq 80m --flash_size detect \\
          0x0 bootloader.bin \\
          0x8000 partition-table.bin \\
          0x10000 naphome-korvo1.bin
        \`\`\`
        " \
          release/bootloader.bin \
          release/partition-table.bin \
          release/naphome-korvo1.bin \
          release/flash.sh \
          release/flash_args.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ steps.get_version.outputs.version }}
        path: release/
        retention-days: 30
